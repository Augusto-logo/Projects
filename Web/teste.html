<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envie seu arquivo PDF</title>
    <script src="https://unpkg.com/pdf-lib@1.4.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
</head>

<body>
    <main>
        <h1>Envie seu arquivo PDF</h1>
        <form id="uploadForm">
            <input type="file" id="pdfFile" accept="application/pdf" required />
            <button type="submit">Enviar</button>
        </form>
    </main>
</body>
<script>

    const { PDFDocument } = PDFLib

    const form = document.getElementById('uploadForm');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById('pdfFile');
        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(arrayBuffer);
        const numPages = pdfDoc.getPageCount();

        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;


        for (let i = 0; i < numPages; i++) {
            const newPdfDoc = await PDFDocument.create();
            const [copiedPage] = await newPdfDoc.copyPages(pdfDoc, [i]);
            newPdfDoc.addPage(copiedPage);

            const pdfBytes = await newPdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            const page = await pdf.getPage(i + 1);
            const textContent = await page.getTextContent();
            const textItems = textContent.items;
            // let pageText = '';
            // for (let j = 0; j < textItems.length; j++) {
            //     pageText += textItems[j].str + ' ';
            // }

            // Manipule o texto extraído aqui
            // const manipulatedText = pageText.trim().toUpperCase(); // Exemplo de manipulação: converter para maiúsculas

            const textoNome = textItems[2].str;
            let nomeArquivo = textoNome.slice(11).toUpperCase() + '.pdf';


            const formData = new FormData();
            formData.append('folderName', file.name);
            // formData.append('file', blob, `page-${i + 1}.pdf`);
            formData.append('file', blob, nomeArquivo);

            try {
                const response = await fetch('http://localhost:3000/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Página enviada com sucesso: ' + JSON.stringify(result));
                } else {
                    console.error('Erro no envio da página');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        alert('Todas as páginas foram enviadas com sucesso');
    });
</script>

</html>